name: Deploy QuvoSalesApp to Digital Tide Demo

on:
  push:
    branches: [ main, master, develop ]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        default: 'demo'
        type: choice
        options:
          - demo
          - dev
          - test

jobs:
  deploy-ios:
    runs-on: macos-latest
    timeout-minutes: 30
    
    env:
      DEVELOPER_DIR: /Applications/Xcode.app/Contents/Developer
      
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # Full history for release notes
    
    - name: Setup Ruby
      uses: ruby/setup-ruby@v1
      with:
        ruby-version: '3.1'
        bundler-cache: true
        
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        
    - name: Cache CocoaPods
      uses: actions/cache@v3
      with:
        path: ios/Pods
        key: ${{ runner.os }}-pods-${{ hashFiles('ios/Podfile.lock') }}
        restore-keys: |
          ${{ runner.os }}-pods-
          
    - name: Install npm dependencies
      run: npm install
      
    - name: Install CocoaPods dependencies
      run: |
        cd ios
        pod install --repo-update
        
    - name: Create environment file
      run: |
        cat > fastlane/.env << EOF
        DIGITAL_TIDE_API_TOKEN=${{ secrets.DIGITAL_TIDE_API_TOKEN }}
        DIGITAL_TIDE_APP_ID=${{ secrets.DIGITAL_TIDE_APP_ID }}
        DIGITAL_TIDE_ENDPOINT=${{ secrets.DIGITAL_TIDE_ENDPOINT }}
        CERTIFICATES_GIT_URL=${{ secrets.CERTIFICATES_GIT_URL }}
        MATCH_PASSWORD=${{ secrets.MATCH_PASSWORD }}
        FASTLANE_TEAM_ID=${{ secrets.FASTLANE_TEAM_ID }}
        FASTLANE_USER=${{ secrets.FASTLANE_USER }}
        SLACK_URL=${{ secrets.SLACK_URL }}
        EOF
        
    - name: Setup Fastlane Match
      env:
        MATCH_PASSWORD: ${{ secrets.MATCH_PASSWORD }}
        CERTIFICATES_GIT_URL: ${{ secrets.CERTIFICATES_GIT_URL }}
      run: |
        bundle exec fastlane ios setup_certificates
        
    - name: Build React Native bundle
      run: |
        npx react-native bundle \
          --platform ios \
          --dev false \
          --entry-file index.js \
          --bundle-output ios/main.jsbundle \
          --assets-dest ios/
          
    - name: Deploy to Digital Tide Demo
      env:
        DIGITAL_TIDE_API_TOKEN: ${{ secrets.DIGITAL_TIDE_API_TOKEN }}
        ENVIRONMENT: ${{ github.event.inputs.environment || 'demo' }}
      run: |
        case "$ENVIRONMENT" in
          demo)
            bundle exec fastlane ios deploy_demo
            ;;
          dev)
            bundle exec fastlane ios build_dev
            ;;
          test)
            bundle exec fastlane ios test
            bundle exec fastlane ios build_dev
            ;;
        esac
        
    - name: Upload build artifacts
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: quvo-sales-app-builds
        path: |
          fastlane/builds/*.ipa
          fastlane/builds/*.dSYM.zip
        retention-days: 30
        
    - name: Notify deployment status
      if: always()
      uses: 8398a7/action-slack@v3
      with:
        status: ${{ job.status }}
        channel: '#deployments'
        webhook_url: ${{ secrets.SLACK_URL }}
        fields: repo,message,commit,author,action,eventName,ref,workflow
        text: |
          QuvoSalesApp deployment to Digital Tide: ${{ job.status }}
          Environment: ${{ github.event.inputs.environment || 'demo' }}
          
    - name: Update deployment status
      if: success()
      run: |
        echo "âœ… QuvoSalesApp successfully deployed to Digital Tide!"
        echo "ğŸ—ï¸ Build completed for: ${{ github.event.inputs.environment || 'demo' }}"
        echo "ğŸ“± Features included:"
        echo "   â€¢ Real Martin Marietta facility data"
        echo "   â€¢ Professional FontAwesome icons"  
        echo "   â€¢ Functional call/email capabilities"
        echo "   â€¢ Order confirmation system"
        echo "   â€¢ Company branding (Quvo + Martin Marietta)"